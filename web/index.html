<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API é…ç½®</title>
</head>

<body class="m-h-screen w-full bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-4">
    <div id="app" class="max-w-4xl mx-auto">
        <div class="bg-white/95 backdrop-blur-sm rounded-3xl shadow-2xl p-8">
            <!-- å¤´éƒ¨ -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-gradient-to-br from-indigo-100 to-purple-100 rounded-xl">
                        <div class="text-3xl">ğŸ¤–</div>
                    </div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        Gemini API é…ç½®
                    </h1>
                </div>
                <a href="/admin/logout" class="text-indigo-600 hover:text-purple-600 font-medium text-sm transition-colors">
                    é€€å‡ºç™»å½•
                </a>
            </div>
            <p class="text-gray-600 text-sm mb-6">é…ç½® Google Gemini çš„è®¤è¯ä¿¡æ¯ï¼Œä¿å­˜åå³å¯è°ƒç”¨ API</p>

            <!-- è·å–è¯´æ˜ -->
            <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 mb-6 text-sm">
                <p class="font-semibold text-gray-800 mb-2">è·å–æ–¹æ³•ï¼š</p>
                <p class="text-gray-700">1. æ‰“å¼€ <a href="https://gemini.google.com" target="_blank" class="text-blue-600 hover:underline">gemini.google.com</a> å¹¶ç™»å½•</p>
                <p class="text-gray-700">2. F12 â†’ ç½‘ç»œ â†’ å‘é€å†…å®¹åˆ°èŠå¤© â†’ ç‚¹å‡»ä»»æ„è¯·æ±‚ â†’ Copy è¯·æ±‚å¤´å†…å®Œæ•´cookie</p>
            </div>

            <!-- è¡¨å• -->
            <form @submit.prevent="handleSubmit">
                <!-- Cookie é…ç½® -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 pb-3 mb-4 border-b-2 border-gray-200">
                        <span class="text-xl">ğŸ”‘</span>
                        <h2 class="text-lg font-semibold text-gray-800">Cookie é…ç½®</h2>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            å®Œæ•´ Cookie <span class="text-red-500">*</span>
                        </label>
                        <textarea v-model="form.fullCookie" @input="parseCookieInput" rows="6" required
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl text-sm font-mono focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all resize-y"
                            placeholder="ç²˜è´´ä»æµè§ˆå™¨å¤åˆ¶çš„å®Œæ•´ Cookie å­—ç¬¦ä¸²ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§£ææ‰€éœ€å­—æ®µå’Œ Token..."></textarea>

                        <!-- è§£æç»“æœ -->
                        <div v-if="parsedFields.length > 0" class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-blue-900 mb-3">âœ… å·²è§£æçš„å­—æ®µï¼š</h4>
                            <div class="space-y-2">
                                <div v-for="field in parsedFields" :key="field.name" class="text-xs text-gray-700">
                                    <span class="font-medium">{{ field.name }}:</span>
                                    <span class="text-green-600 font-mono ml-2">{{ field.value }}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ¨¡å‹ ID é…ç½® -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 pb-3 mb-4 border-b-2 border-gray-200">
                        <span class="text-xl">ğŸ¯</span>
                        <h2 class="text-lg font-semibold text-gray-800">
                            æ¨¡å‹ ID é…ç½®
                            <span class="text-xs text-gray-500 font-normal ml-2">(å¯é€‰ï¼Œå¦‚æœæ¨¡å‹åˆ‡æ¢å¤±æ•ˆè¯·æ›´æ–°)</span>
                        </h2>
                    </div>

                    <div class="bg-amber-50 border-l-4 border-amber-500 rounded-lg p-4 mb-4 text-sm">
                        <p class="font-semibold text-gray-800 mb-1">è·å–æ–¹æ³•ï¼š</p>
                        <p class="text-gray-700">F12 â†’ Network â†’ åœ¨ Gemini ä¸­åˆ‡æ¢æ¨¡å‹å‘é€æ¶ˆæ¯ â†’ æ‰¾åˆ°è¯·æ±‚å¤´ <code class="bg-amber-100 px-1.5 py-0.5 rounded text-xs">x-goog-ext-525001261-jspb</code> â†’ å¤åˆ¶æ•´ä¸ªæ•°ç»„å€¼ç²˜è´´åˆ°ä¸‹æ–¹è¾“å…¥æ¡†</p>
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            å¿«é€Ÿè§£æ <span class="text-xs text-gray-500">(ç²˜è´´è¯·æ±‚å¤´æ•°ç»„è‡ªåŠ¨æå– ID)</span>
                        </label>
                        <input type="text" v-model="modelIdParser" @input="parseModelIdInput"
                            class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all"
                            placeholder='ç²˜è´´å¦‚: [1,null,null,null,"56fdd199312815e2",null,null,0,[4],null,null,2]'>

                        <!-- è§£æçš„æ¨¡å‹ ID -->
                        <div v-if="parsedModelId" class="mt-3 bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="text-sm font-semibold text-green-900 mb-3">âœ… å·²æå–çš„æ¨¡å‹ IDï¼š</h4>
                            <div class="text-xs mb-3">
                                æå–åˆ°çš„ ID: <span class="text-green-600 font-mono font-semibold">{{ parsedModelId }}</span>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" @click="fillModelId('flash')"
                                    class="px-3 py-1.5 bg-indigo-500 text-white text-xs rounded-lg hover:bg-indigo-600 transition-colors">
                                    å¡«å…¥æé€Ÿç‰ˆ
                                </button>
                                <button type="button" @click="fillModelId('pro')"
                                    class="px-3 py-1.5 bg-purple-500 text-white text-xs rounded-lg hover:bg-purple-600 transition-colors">
                                    å¡«å…¥Proç‰ˆ
                                </button>
                                <button type="button" @click="fillModelId('thinking')"
                                    class="px-3 py-1.5 bg-pink-500 text-white text-xs rounded-lg hover:bg-pink-600 transition-colors">
                                    å¡«å…¥æ€è€ƒç‰ˆ
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æé€Ÿç‰ˆ (Flash) ID</label>
                            <input type="text" v-model="form.modelIdFlash"
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all"
                                placeholder="56fdd199312815e2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Pro ç‰ˆ ID</label>
                            <input type="text" v-model="form.modelIdPro"
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all"
                                placeholder="e6fa609c3fa255c0">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">æ€è€ƒç‰ˆ (Thinking) ID</label>
                            <input type="text" v-model="form.modelIdThinking"
                                class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-100 transition-all"
                                placeholder="e051ce1aa80aa576">
                        </div>
                    </div>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button type="submit" :disabled="isLoading"
                    class="w-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white font-semibold py-3.5 px-6 rounded-xl text-base hover:shadow-xl hover:shadow-purple-500/50 hover:scale-[1.02] active:scale-[0.98] transition-all disabled:opacity-60 disabled:cursor-not-allowed disabled:hover:scale-100">
                    <span v-if="isLoading" class="inline-flex items-center gap-2">
                        <svg class="animate-spin h-5 w-5" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        ä¿å­˜ä¸­...
                    </span>
                    <span v-else>ğŸ’¾ ä¿å­˜é…ç½®</span>
                </button>
            </form>

            <!-- çŠ¶æ€æ¶ˆæ¯ -->
            <div v-if="statusMessage.text" :class="statusMessage.type === 'success' ? 'bg-green-50 border-green-500 text-green-700' : 'bg-red-50 border-red-500 text-red-700'"
                class="mt-5 border-l-4 rounded-lg px-4 py-3 text-sm" v-html="statusMessage.text">
            </div>

            <!-- API è°ƒç”¨ä¿¡æ¯ -->
            <div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-indigo-500 rounded-lg p-6">
                <h3 class="text-base font-semibold text-gray-800 mb-4">ğŸ“¡ API è°ƒç”¨ä¿¡æ¯</h3>
                <div class="space-y-2 text-sm mb-4">
                    <p><span class="font-medium">Base URL:</span> <strong class="text-indigo-600">{{ apiInfo.baseUrl }}</strong></p>
                    <p><span class="font-medium">API Key:</span> <strong class="text-indigo-600">{{ apiInfo.apiKey }}</strong></p>
                    <p><span class="font-medium">å¯ç”¨æ¨¡å‹:</span> <code class="bg-white px-2 py-0.5 rounded text-xs">gemini-3.0-flash</code> | <code class="bg-white px-2 py-0.5 rounded text-xs">gemini-3.0-pro</code> | <code class="bg-white px-2 py-0.5 rounded text-xs">gemini-3.0-flash-thinking</code></p>
                </div>

                <h4 class="text-sm font-semibold text-gray-800 mt-5 mb-2">ğŸ’¬ æ–‡æœ¬å¯¹è¯</h4>
                <pre class="bg-white rounded-lg p-4 text-xs overflow-x-auto border border-gray-200">from openai import OpenAI
client = OpenAI(base_url="{{ apiInfo.baseUrl }}", api_key="{{ apiInfo.apiKey }}")

response = client.chat.completions.create(
    model="gemini-3.0-flash",  # æˆ– gemini-3.0-pro / gemini-3.0-flash-thinking
    messages=[{"role": "user", "content": "ä½ å¥½"}]
)
print(response.choices[0].message.content)</pre>

                <h4 class="text-sm font-semibold text-gray-800 mt-5 mb-2">ğŸ–¼ï¸ å›¾ç‰‡è¯†åˆ«</h4>
                <pre class="bg-white rounded-lg p-4 text-xs overflow-x-auto border border-gray-200">import base64
from openai import OpenAI
client = OpenAI(base_url="{{ apiInfo.baseUrl }}", api_key="{{ apiInfo.apiKey }}")

# è¯»å–æœ¬åœ°å›¾ç‰‡
with open("image.png", "rb") as f:
    img_b64 = base64.b64encode(f.read()).decode()

response = client.chat.completions.create(
    model="gemini-3.0-flash",
    messages=[{
        "role": "user",
        "content": [
            {"type": "text", "text": "è¯·æè¿°è¿™å¼ å›¾ç‰‡"},
            {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{img_b64}"}}
        ]
    }]
)
print(response.choices[0].message.content)</pre>

                <h4 class="text-sm font-semibold text-gray-800 mt-5 mb-2">ğŸŒŠ æµå¼å“åº”</h4>
                <pre class="bg-white rounded-lg p-4 text-xs overflow-x-auto border border-gray-200">stream = client.chat.completions.create(
    model="gemini-3.0-flash",
    messages=[{"role": "user", "content": "å†™ä¸€é¦–è¯—"}],
    stream=True
)
for chunk in stream:
    if chunk.choices[0].delta.content:
        print(chunk.choices[0].delta.content, end="", flush=True)</pre>

                <h4 class="text-sm font-semibold text-gray-800 mt-5 mb-2">ğŸ“· ç¤ºä¾‹å›¾ç‰‡</h4>
                <p class="text-xs text-gray-600 mb-3">ä»¥ä¸‹æ˜¯ image.png ç¤ºä¾‹å›¾ç‰‡ï¼Œå¯ç”¨äºæµ‹è¯•å›¾ç‰‡è¯†åˆ«åŠŸèƒ½ï¼ˆç‚¹å‡»æ”¾å¤§ï¼‰ï¼š</p>
                <img src="/web/img/image.png" alt="ç¤ºä¾‹å›¾ç‰‡" @click="showModal = true" @error="imageError = true"
                    v-if="!imageError"
                    class="max-w-xs rounded-lg border border-gray-300 cursor-pointer hover:shadow-lg transition-shadow">
                <p v-else class="text-xs text-gray-400">ï¼ˆç¤ºä¾‹å›¾ç‰‡ä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿ image.png æ–‡ä»¶å­˜åœ¨ï¼‰</p>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
    <!-- <div v-if="showModal" @click="showModal = false"
        class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center cursor-pointer p-5">
        <img src="/web/img/image.png" alt="ç¤ºä¾‹å›¾ç‰‡" class="max-w-[90%] max-h-[90%] rounded-lg shadow-2xl">
        <span class="absolute top-5 right-8 text-white text-4xl hover:text-gray-300 transition-colors">&times;</span>
    </div> -->

    <script src="/web/utils/index.js"></script>
    <script src="/web/lib/tailwindcss.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
        const { createApp, ref, reactive, computed, onMounted } = Vue;

        createApp({
            setup() {
                const form = reactive({
                    fullCookie: cookieStr,
                    modelIdFlash: '',
                    modelIdPro: '',
                    modelIdThinking: ''
                });

                const modelIdParser = ref('');
                const parsedModelId = ref('');
                const parsedFields = ref([]);
                const isLoading = ref(false);
                const statusMessage = reactive({ text: '', type: '' });
                const showModal = ref(false);
                const imageError = ref(false);

                // API ä¿¡æ¯ï¼ˆä»æœåŠ¡å™¨æ¨¡æ¿æ³¨å…¥ï¼‰
                const apiInfo = reactive({
                    baseUrl: '',
                    apiKey: ''
                });


                const cookieDisplayNames = {
                    'SECURE_1PSID': '__Secure-1PSID',
                    'SECURE_1PSIDTS': '__Secure-1PSIDTS',
                    'SAPISID': 'SAPISID',
                    'SID': 'SID',
                    'HSID': 'HSID',
                    'SSID': 'SSID',
                    'APISID': 'APISID'
                };


                // è§£æ Cookie è¾“å…¥
                const parseCookieInput = () => {
                    const parsed = cookieHeloer.parseCookie(form.fullCookie);
                    console.log(8989, parsed);
                    
                    parsedFields.value = Object.entries(cookieDisplayNames)
                        .filter(([key]) => parsed[key])
                        .map(([key, name]) => ({
                            name,
                            value: parsed[key].length > 30 ? parsed[key].substring(0, 30) + '...' : parsed[key]
                        }));
                };

                // è§£ææ¨¡å‹ ID
                const parseModelId = (input) => {
                    try {
                        const arr = JSON.parse(input);
                        if (Array.isArray(arr) && arr.length > 4 && typeof arr[4] === 'string') {
                            return arr[4];
                        }
                    } catch (e) {
                        const match = input.match(/["']([a-f0-9]{16})["']/i);
                        if (match) return match[1];
                    }
                    return null;
                };

                // è§£ææ¨¡å‹ ID è¾“å…¥
                const parseModelIdInput = () => {
                    parsedModelId.value = parseModelId(modelIdParser.value) || '';
                };

                // å¡«å…¥æ¨¡å‹ ID
                const fillModelId = (type) => {
                    if (type === 'flash') form.modelIdFlash = parsedModelId.value;
                    else if (type === 'pro') form.modelIdPro = parsedModelId.value;
                    else if (type === 'thinking') form.modelIdThinking = parsedModelId.value;
                };

                // åŠ è½½é…ç½®
                const loadConfig = async () => {
                    try {
                        const { data } = await axios.get('/admin/config', { withCredentials: true });
                        if (data.FULL_COOKIE) {
                            form.fullCookie = data.FULL_COOKIE;
                            parseCookieInput();
                        }
                        if (data.MODEL_IDS) {
                            form.modelIdFlash = data.MODEL_IDS.flash || '';
                            form.modelIdPro = data.MODEL_IDS.pro || '';
                            form.modelIdThinking = data.MODEL_IDS.thinking || '';
                        }
                    } catch (err) {
                        console.log('åŠ è½½é…ç½®å¤±è´¥:', err);
                    }
                };

                // æäº¤è¡¨å•
                const handleSubmit = async () => {
                    statusMessage.text = '';
                    isLoading.value = true;

                    try {
                        const payload = {
                            FULL_COOKIE: form.fullCookie,
                            MODEL_IDS: {
                                flash: form.modelIdFlash || '',
                                pro: form.modelIdPro || '',
                                thinking: form.modelIdThinking || ''
                            }
                        };

                        const { data } = await axios.post('/admin/save', payload, {
                            headers: { 'Content-Type': 'application/json' },
                            withCredentials: true
                        });

                        if (data.success) {
                            statusMessage.type = 'success';
                            statusMessage.text = `âœ… ${data.message}<br><br>ğŸ’¡ <strong>é…ç½®å·²ç”Ÿæ•ˆï¼Œæ— éœ€é‡å¯æœåŠ¡ï¼</strong>`;
                        } else {
                            statusMessage.type = 'error';
                            statusMessage.text = `âŒ ${data.message}`;
                        }
                    } catch (err) {
                        if (err.response?.status === 401) {
                            window.location.href = '/admin/login';
                            return;
                        }
                        statusMessage.type = 'error';
                        statusMessage.text = `âŒ ä¿å­˜å¤±è´¥: ${err.response?.data?.message || err.message}`;
                    } finally {
                        isLoading.value = false;
                    }
                };

                // ESC å…³é—­æ¨¡æ€æ¡†
                const handleKeydown = (e) => {
                    if (e.key === 'Escape') showModal.value = false;
                };

                onMounted(async () => {
                    // ä»é…ç½® API è·å–åŸºæœ¬ä¿¡æ¯
                    try {
                        const { data } = await axios.get('/api/user/config', { withCredentials: true });
                        console.log(11111, data)
                        if (data.API_KEY) apiInfo.apiKey = data.API_KEY;
                        if (data.PORT) apiInfo.baseUrl = `http://localhost:${data.PORT}/v1`;
                    } catch (err) {
                        // ä½¿ç”¨é»˜è®¤å€¼
                        apiInfo.baseUrl = `${window.location.protocol}//${window.location.host}/v1`;
                        apiInfo.apiKey = 'your-api-key';
                    }

                    // loadConfig();
                    // document.addEventListener('keydown', handleKeydown);
                });

                return {
                    form,
                    modelIdParser,
                    parsedModelId,
                    parsedFields,
                    isLoading,
                    statusMessage,
                    showModal,
                    imageError,
                    apiInfo,
                    parseCookieInput,
                    parseModelIdInput,
                    fillModelId,
                    handleSubmit
                };
            }
        }).mount('#app');
    </script>
</body>

</html>
